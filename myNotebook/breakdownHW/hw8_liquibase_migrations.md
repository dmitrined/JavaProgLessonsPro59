# Отчет по миграциям Liquibase (db.changelog)

Liquibase — это инструмент для управления версиями базы данных (Database Migration Tool). Он позволяет отслеживать, управлять и применять изменения схемы базы данных (DDL) и данных (DML) в виде "чейнджсетов" (changeSets).

В данном проекте используется подход, когда каждый набор изменений вынесен в отдельный файл, а `db.changelog-master.xml` объединяет их все. Это хорошая практика, позволяющая держать миграции структурированными и читаемыми.

Ниже приведен детальный разбор каждого файла с теоретическими пояснениями.

---

## 1. `db.changelog-master.xml`
**Роль:** Главный файл (Master Changelog).

**Описание:** Это точка входа для Liquibase. Он не содержит самих изменений, а только ссылки (`<include>`) на другие файлы миграций.

**Теория:** Liquibase выполняет файлы строго в том порядке, в котором они указаны в этом файле. Это гарантирует последовательное применение изменений (сначала создание таблицы, потом добавление колонок и т.д.).

```xml
<include file="db/changelog/001-create-cars-table.xml"/>
<include file="db/changelog/002-add-collumns.xml"/>
```

---

## 2. `001-create-cars-table.xml`
**Действие:** Создание таблицы `cars`.

**Ключевые элементы:**
*   `<createTable tableName="cars">`: Команда создания таблицы.
*   `id` (BIGINT, PK, AutoIncrement): Первичный ключ. `autoIncrement="true"` означает, что БД сама будет генерировать уникальные ID (1, 2, 3...).
*   `constraints nullable="false"`: Ограничение `NOT NULL` (поле обязательно для заполнения).

**Теория:** Это базовая миграция (DDL - Data Definition Language). Она определяет начальную структуру сущности.

---

## 3. `002-add-collumns.xml`
**Действие:** Добавление новых колонок (`color`, `horsepower`) в существующую таблицу.

**Ключевые элементы:**
*   `<addColumn tableName="cars">`: Команда модификации таблицы (аналог SQL `ALTER TABLE ADD COLUMN`).

**Теория:** В реальной разработке требования меняются. Мы не правим старый файл `001`, так как он уже мог быть применен на продакшене (изменять примененные changeSet-ы нельзя, это вызовет ошибку контрольной суммы). Вместо этого мы создаем **новую** миграцию для изменений.

---

## 4. `003-modify-column.xml`
**Действие:** Изменение типа данных колонки `mileage`.

**Ключевые элементы:**
*   `<modifyDataType ... newDataType="BIGINT"/>`: Изменяет тип с `INT` на `BIGINT`.

**Теория:** Используется, когда нужно изменить характеристики колонки (тип, размер, nullability). Аналог SQL `ALTER TABLE MODIFY COLUMN`.

---

## 5. `004-seed-test-data.xml`
**Действие:** Вставка начальных данных (DML - Data Manipulation Language).

**Ключевые элементы:**
*   `<insert tableName="cars">`: Вставляет запись.
*   `valueNumeric`, `value`: Атрибуты для указания значений разных типов.

**Теория:** DML-миграции используются для наполнения справочников или создания базовых записей, необходимых для работы приложения. В данном случае вставляется первая запись о машине.

---

## 6. `005-add-audit-columns.xml`
**Действие:** Добавление колонок аудита (`created_at`, `updated_at`).

**Ключевые элементы:**
*   `defaultValueComputed="CURRENT_TIMESTAMP"`: Указывает базе данных автоматически подставлять текущее время при вставке записи.

**Теория:** Колонки аудита — стандартная практика. Они позволяют знать, когда запись была создана и когда последний раз изменена, что критично для отладки и аналитики.

---

## 7. `006-add-check-constraints.xml`
**Действие:** Добавление проверок (Constraints) на уровне БД.

**Ключевые элементы:**
*   `<sql>`: Позволяет выполнять "сырой" SQL, когда стандартных тегов XML недостаточно.
*   `CHECK (price > 0)`: Гарантирует, что цена положительна.
*   `CHECK (mileage >= 0)`: Пробег не может быть отрицательным.
*   `CHECK (production_year >= 1900)`: Ограничение по году выпуска.

**Теория:** `CHECK` constraints обеспечивают целостность данных на самом низком уровне. Это "последний рубеж" защиты данных от некорректных значений, действующих независимо от логики приложения.

---

## 8. `007-add-soft-delete-flag.xml`
**Действие:** Добавление флага для "мягкого удаления" (`deleted`).

**Ключевые элементы:**
*   `defaultValueBoolean="false"`: По умолчанию машина считается активной (не удаленной).

**Теория:** **Soft Delete** — паттерн, при котором данные физически не удаляются из БД (`DELETE`), а просто помечаются как удаленные (`UPDATE cars SET deleted = true`). Это позволяет восстановить данные при ошибке пользователя и сохранять историю для аналитики.

---

## 9. `008-seed-test-data-only-test.xml`
**Действие:** Дополнительные тестовые данные.

**Ключевые элементы:**
*   `context="test"`: **Важный момент!** Этот чейнджсет выполнится *только* если Liquibase запущен с профилем/контекстом `test`. Это позволяет разделять данные для разработки и тестирования.

**Теория:** Использование контекстов (`context`) позволяет гибко управлять тем, какие изменения должны применяться в различных окружениях (Dev, Test, Prod). В данном файле мы добавляем расширенный набор данных, специфичный именно для тестовых сценариев.

---

## Итог
Структура миграций в проекте покрывает основные сценарии профессиональной разработки:
1.  **Создание схемы** (`createTable`).
2.  **Эволюция схемы** (`addColumn`, `modifyDataType`).
3.  **Заполнение данными** (`insert`).
4.  **Обеспечение целостности** (`constraints`).
5.  **Разделение сред** (`context="test"`).
